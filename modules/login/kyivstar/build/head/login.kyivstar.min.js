var g_headers={Accept:"*/*","Accept-Language":"en-US,en;q=0.9,ru;q=0.8,ru-RU;q=0.7","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36",Connection:"keep-alive"},g_gwtCfg={url:"https://account.kyivstar.ua/cas/auth/",strong_name:"\\(\\['safari'\\],\\s*?'([^']*)'\\)",auth_nocache:"auth.nocache.js",magic_id:"7EFB8080DC0FE63D10CD1D1F2C31C919"};function isLoggedIn(a){return isLoggedInOld(a)||isLoggedInNew(a)||isNewDemo(a)}
function isLoggedInOld(a){return/\/tbmb\/logout\/perform/i.test(a)}function isNewDemo(a){return/<a[^>]+new.kyivstar.ua\/ecare\/[^>]+ks-button/i.test(a)}
function checkGwtError(a){try{return gwtGetJSON(a)}catch(c){if(/AccountException\$Type\/603172321/i.test(c.message))throw new AnyBalance.Error("Превышено количество не успешных попыток входа. Ваша учетная запись временно заблокирована. Блокировка будет снята автоматически через 180 минут");if(/accountNotFound|AccountException|passwordNotFound/i.test(c.message))throw new AnyBalance.Error("Пользователь с таким логином не найден!",null,!0);if(/RecaptchaException/i.test(a))throw new AnyBalance.Error("К сожалению, Киевстар потребовал ввода капчи для этого номера. Зайдите в личный кабинет один раз через браузер.",
null,!0);if(c)throw c;throw new AnyBalance.Error("Не удалось получить токен авторизации. Сайт изменен или требуется вход в личный кабинет через браузер на этом устройстве",null,!0);}}function initializeLogin(){var a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите номер вашего телефона для входа в Мой Киевстар (в формате +380ХХХХХХХХХ), например +380971234567");checkEmpty(a.password,"Введите пароль!")}function isThereLoginForm(a){return getElement(a,/<form[^>]+id="auth-form"[^>]*>/i)}
function loginBasic(a){var c=AnyBalance.getPreferences(),d=AnyBalance.getLastUrl(),b=isThereLoginForm(a);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");AnyBalance.trace("форма входа найдена");var h=gwtLoadStrongName(g_gwtCfg);authRequestCaptcha="7|0|10|%url%|%magic_id%|ua.kyivstar.cas.shared.rpc.AuthSupportRPCService|authenticate|java.lang.String/2004016611|Z|%LOGIN%|%PASSWORD%|%RECAPTCHA%|https://account.kyivstar.ua/cas/login?service=https%3A%2F%2Fb2b.kyivstar.ua%2Ftbmb%2Fnew%2F#password:%LOGIN%|1|2|3|4|5|5|5|5|6|5|7|8|9|0|10|";
a=AnyBalance.requestPost(g_gwtCfg.url+"authSupport.rpc",makeReplaces("7|0|6|%url%|%magic_id%|ua.kyivstar.cas.shared.rpc.AuthSupportRPCService|getLoginAuthDetails|java.lang.String/2004016611|%LOGIN%|1|2|3|4|1|5|6|",g_gwtCfg).replace(/%LOGIN%/g,gwtEscape(c.login)),addHeaders({Origin:"https://account.kyivstar.ua"},gwtHeaders(h,g_gwtCfg)));var e={msisdn:"MSISDN_PASSWORD",fttb:"ACCOUNT_PASSWORD"},f=getParam(a,null,null,/"([^"]*)"\]/i,replaceSlashes);e[f]||(AnyBalance.trace("Неизвестный тип входа: "+f+
"\n"+a),f="msisdn");if(3<=checkGwtError(a)[12]){AnyBalance.trace("Потребовалась рекапча...");var l=solveRecaptcha("К сожалению, Киевстар потребовал ввода капчи для этого номера. Решите её или зайдите в личный кабинет один раз через браузер.",d,"6LdmHxMTAAAAAOC1FPK3u0jx00AbkUj_OvQXN0yR")}AnyBalance.trace("Получаем токен для входа...");a=AnyBalance.requestPost(g_gwtCfg.url+"authSupport.rpc",makeReplaces(l?authRequestCaptcha:"7|0|9|%url%|%magic_id%|ua.kyivstar.cas.shared.rpc.AuthSupportRPCService|authenticate|java.lang.String/2004016611|Z|%LOGIN%|%PASSWORD%|https://account.kyivstar.ua/cas/login?service=https%3A%2F%2Fb2b.kyivstar.ua%2Ftbmb%2Fnew%2F#password:%LOGIN%|1|2|3|4|5|5|5|5|6|5|7|8|0|0|9|",
g_gwtCfg).replace(/%LOGIN%/g,gwtEscape(c.login.replace(/\D+/g,""))).replace(/%PASSWORD%/g,gwtEscape(c.password)).replace(/%RECAPTCHA%/g,gwtEscape(l||"")),addHeaders({Origin:"https://account.kyivstar.ua"},gwtHeaders(h,g_gwtCfg)));AnyBalance.trace("html:"+a);checkGwtError(a);var k=getParam(a,null,null,/AuthResult[^"]*","([^"]*)/,replaceSlashes);AnyBalance.trace("token:"+k);if(!k)throw new AnyBalance.Error("Персональный пароль указан неверно!",null,!0);a=AB.createFormParams(b,function(n,p,g,m){return"username"==
g?c.login.replace(/\D+/g,""):"password"==g?c.password:"authenticationType"==g?e[f]:"rememberMe"==g?"true":"token"==g?k:m});b=getParam(b,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);AnyBalance.trace("action:"+b);AnyBalance.trace("Завершаем вход...");a=AnyBalance.requestPost("https://account.kyivstar.ua/cas/login?service=http%3A%2F%2Fnew.kyivstar.ua%2Fecare%2F",a,addHeaders({Referer:d}));d=getParam(d,null,null,/https?:\/\/[^\/]*/i);0===AnyBalance.getLastUrl().indexOf(d)&&(AnyBalance.trace("Сразу не вошли, надо попробовать чуть-чуть подождать"),
AnyBalance.sleep(3E3),a=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers));if(0===AnyBalance.getLastUrl().indexOf(d))throw AnyBalance.trace("Переадресовали на "+AnyBalance.getLastUrl()+":\n"+a),new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");AnyBalance.trace("В результате входа перешли на "+AnyBalance.getLastUrl());return a}
function loadAuthorizationPage(a){clearAllCookies();AnyBalance.trace("Удалили все куки");return AnyBalance.requestGet("https://account.kyivstar.ua/cas/login?"+a,g_headers)}function goToOldSite(a){if(isLoggedInNew(a)||isNewDemo(a))AnyBalance.trace("Новый лк или его реклама, переходим на старый"),a=AnyBalance.requestGet("https://account.kyivstar.ua/cas/login?service=http%3A%2F%2Fmy.kyivstar.ua%3A80%2Ftbmb%2FMK2.do",g_headers);return a}
function isLoggedInNew(a){return/var\s+pageData\s*=/.test(a)&&!/"event":"session_start"/.test(a)}
function goToNewSite(a){if(!isLoggedInNew(a)){AnyBalance.trace("Загружаем https://new.kyivstar.ua/ecare/");a=AnyBalance.requestGet("https://new.kyivstar.ua/ecare/",g_headers);for(var c=0;/var\s+pageData\s*=/.test(a)&&/"event":"session_start"/.test(a)&&10>c;)AnyBalance.trace("Не все данные получены, надо попробовать чуть-чуть подождать"),AnyBalance.sleep(1E3),c+=1,a=AnyBalance.requestGet("https://new.kyivstar.ua/ecare/",g_headers)}return a}
function goToSite(a){isNewDemo(a)&&(AnyBalance.trace("Показана страница рекламы нового кабинета, переходим в новый кабинет"),a=AnyBalance.requestGet("https://new.kyivstar.ua/ecare/",g_headers));return a}
function loginSite(a){function c(e){if(isLoggedInNew(e)||isNewDemo(e))AnyBalance.trace("Выходим из нового ЛК"),e=AnyBalance.requestGet("https://new.kyivstar.ua/ecare/logout",g_headers);else{AnyBalance.trace("Пытаемся выйти "+(isLoggedIn(e)?" из старого ЛК":" (но не залогинены?)"));e=AnyBalance.requestGet(a+"tbmb/logout/perform.do",g_headers);var f=getParam(e,null,null,/<a[^>]+id="submitBtn"[^>]*href="([^"]*)/i,replaceHtmlEntities);f&&(AnyBalance.trace("Переход на страницу входа."),e=AnyBalance.requestGet(f,
g_headers))}return e}var d=AnyBalance.getPreferences();initializeLogin();AnyBalance.trace("Логин на сайт.");AnyBalance.trace("Соединение с "+a);var b=AnyBalance.requestGet(a+"tbmb/disclaimer/show.do",g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");AnyBalance.trace("Успешное соединение.");if(isLoggedIn(b)&&(AnyBalance.trace("Уже в системе."),b=goToSite(b),0>b.indexOf(d.login.substr(-10)))){var h=
getParam(b,null,null,[/Номер:[\s\S]*?<td[^>]*>([^<]*)/i,/"subscriptionIdentifier"\s*:\s*"([^"]*)/],replaceTagsAndSpaces);AnyBalance.trace("Не тот аккаунт, выход (нужно "+d.login+", вошли на "+h+").");b=c(b)}isLoggedIn(b)||(isThereLoginForm(b)||(AnyBalance.trace(b),AnyBalance.trace("Не найдена форма входа. Выходим и явно переходим на авторизацию."),b=c(b),AnyBalance.trace("Сейчас мы на "+AnyBalance.getLastUrl()+". Переходим на авторизацию."),b=loadAuthorizationPage("service=https%3A%2F%2Fb2b.kyivstar.ua%2Ftbmb%2Fnew%2F")),
b=loginBasic(b),b=goToSite(b));if(!isLoggedIn(b))for(d=0;/var\s+pageData\s*=/.test(b)&&/"event":"session_start"/.test(b)&&10>d;)AnyBalance.trace("Залогинены, но нужно перезагрузить страницу "+AnyBalance.getLastUrl()),AnyBalance.sleep(1E3),b=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),d+=1;if(!isLoggedIn(b)){if(d=getParam(b,null,null,/<td[^>]+class="(?:redError|casError)"[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d,null,/Перевірте правильність введення логіну|введіть правильний пароль/i.test(d));
if(/<form[^>]+action="[^"]*perform.do"/i.test(b))throw new AnyBalance.Error("Киевстар показал форму входа без ошибки. Возможно, вы пытаетесь войти в кабинет через мобильный интернет. На стороне Киевстара сейчас с этим проблема. Попробуйте обновить провайдер через вайфай.");AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в систему. Сайт изменен?");}AnyBalance.trace("Успешный вход.");return b}
function loginMobile(a){initializeLogin();AnyBalance.trace("Логин в мобильное приложение.");a=loadAuthorizationPage("locale=ru_ru&service=https://b2b.kyivstar.ua/tbmb/_assets_mobconv/portmone/index.html&renew=true&compact=1");if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");AnyBalance.trace("Успешное соединение.");return a=loginBasic(a)};
