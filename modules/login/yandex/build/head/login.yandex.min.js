function apiPost(b,l,a,h){b=AnyBalance.requestPost(b,{csrf_token:csrf,track_id:track_id},addHeaders({"X-Requested-With":"XMLHttpRequest",Origin:baseurl,Referer:referer}));json=getJson(b);if("ok"!==json.status)throw AnyBalance.trace(b),b=(json.errors||json.error).join("; "),new AnyBalance.Error("Пароль не принят: "+b,null,/not_matched/.test(b));}
function loginYandex(b,l,a,h,m){function d(f,g,r,q){f=AnyBalance.requestPost("https://passport.yandex.ru/"+f,g,addHeaders({"X-Requested-With":"XMLHttpRequest",Origin:"https://passport.yandex.ru",Referer:p}));g=getJson(f);if("ok"!==g.status&&(g.error||g.errors&&"captcha.required"!==g.errors[0]))throw AnyBalance.trace(f),f=(g.errors||g.error).join("; "),new AnyBalance.Error(r+": "+f,null,q&&q.test(f));return g}function t(){AnyBalance.trace("Потребовался ввод текстовой капчи");json=d("registration-validations/textcaptcha",
{csrf_token:e,track_id:c,language:"ru",scale_factor:3},"Запрос на отправку капчи не принят");var f=AnyBalance.requestGet(json.image_url,g_headers),g=json.key;f=AnyBalance.retrieveCode("В некоторых случаях Яндекс использует защиту от роботов в виде текстовой капчи.\nПожалуйста, введите символы с картинки",f,{time:18E4});json=d("registration-validations/checkHuman",{csrf_token:e,track_id:c,answer:f,key:g},"Запрос на проверку ответа не принят")}var n={};m&&(n.origin=m);h&&(n.retpath=h);var p="https://passport.yandex.ru/auth/?"+
createUrlEncodedParams(n);a||(a=AnyBalance.requestGet(p,g_headers));var e=getParam(a,/<input[^>]+name="csrf_token"[^>]*value="([^"]*)/i,replaceHtmlEntities);n=getParam(a,/process_uuid=([^&"]*)/i,replaceHtmlEntities,decodeURIComponent);json=d("registration-validations/auth/multi_step/start",{csrf_token:e,login:b,process_uuid:n,retpath:h,origin:m},"Вход не может быть выполнен. Сайт изменен?",/userNotFound|prohibitedsymbols/);if(!json.can_authorize)throw AnyBalance.trace(a),new AnyBalance.Error("Этот логин не может быть авторизован (неверный логин)",
null,!0);var c=json.track_id;json=d("registration-validations/auth/multi_step/commit_password",{csrf_token:e,track_id:c,password:l,retpath:h},"Пароль не принят",/not_matched/);json.errors&&"captcha.required"==json.errors[0]&&(t(),json=d("registration-validations/auth/multi_step/commit_password",{csrf_token:e,track_id:c,password:l,retpath:h},"Пароль не принят",/not_matched/));if("change_password"==json.state)throw AnyBalance.trace("Потребовалась смена пароля"),new AnyBalance.Error("Яндекс требует сменить пароль. Пожалуйста, перейдите на страницу авторизации https://passport.yandex.ru/auth/welcome через браузер, смените пароль и введите новый пароль в настройки провайдера",
null,!0);if("auth_challenge"==json.state&&(AnyBalance.trace("Потребовалась дополнительная проверка входа"),json=d("registration-validations/auth/challenge/submit",{csrf_token:e,track_id:c},"Запрос на проверку входа не принят"),AnyBalance.trace(JSON.stringify(json)),b=json.challenge.challengeType,l=json.challenge.phoneId,m=json.challenge.hint,"mobile_id"==b&&(json.challenge.alternative.challengeType?(AnyBalance.trace("Альтернативный способ подтверждения входа найден. Устанавливаем подтверждение "+
json.challenge.alternative.challengeType),b=json.challenge.alternative.challengeType):(AnyBalance.trace("Альтернативных способов подтверждения входа не найдено. Устанавливаем подтверждение по телефону"),b="phone_confirmation")),!/auth\/challenge\/commit/i.test(AnyBalance.getLastUrl())))if("phone_confirmation"==b){AnyBalance.trace("Требуется подтверждение по телефону");json=d("registration-validations/auth/validate_phone_by_id",{csrf_token:e,track_id:c,phoneId:l},"Запрос на валидацию не принят");if(0==
json.valid_for_flash_call&&0==json.valid_for_call){AnyBalance.trace("Требуется подтверждение с помощью кода из SMS");var k="by_sms"}else if(1==json.valid_for_flash_call&&1==json.valid_for_call)AnyBalance.trace("Требуется подтверждение с помощью входящего звонка"),k="by_flash_call";else if(!json.valid_for_flash_call&&!json.valid_for_call)throw AnyBalance.trace(a),new AnyBalance.Error("Требуемое подтверждение не поддерживается");json=d("registration-validations/phone-confirm-code-submit",{csrf_token:e,
track_id:c,phone_id:l,confirm_method:k,isCodeWithFormat:!0},"Запрос на отправку кода не принят");a=json.global_sms_id?AnyBalance.retrieveCode("Пожалуйста, введите код из "+json.code_length+" цифр из SMS, отправленного на ваш номер "+json.number.masked_international,null,{inputType:"number",time:18E4}):AnyBalance.retrieveCode("Пожалуйста, введите последние "+json.code_length+" цифры номера телефона из звонка, поступившего на ваш номер "+json.number.masked_international,null,{inputType:"number",time:18E4});
json=d("registration-validations/phone-confirm-code",{csrf_token:e,track_id:c,code:a},"Запрос на подтверждение кода не принят");json=d("registration-validations/auth/challenge/commit",{csrf_token:e,track_id:c,challenge:b},"Ошибка подтверждения входа")}else if("push_2fa"==b)AnyBalance.trace("Требуется подтверждение через мобильный Яндекс"),json=d("registration-validations/auth/challenge/send_push",{csrf_token:e,track_id:c},"Запрос на отправку уведомления не принят"),a=AnyBalance.retrieveCode("Пожалуйста, введите код из уведомления, отправленного в мобильное приложение Яндекс на вашем устройстве",
null,{inputType:"number",time:18E4}),json=d("registration-validations/auth/challenge/commit",{csrf_token:e,track_id:c,challenge:b,answer:a},"Ошибка подтверждения входа");else if("email_code"==b)AnyBalance.trace("Требуется подтверждение через E-mail"),json=d("registration-validations/auth/challenge/send_code_to_email",{csrf_token:e,track_id:c},"Запрос на отправку уведомления не принят"),a=AnyBalance.retrieveCode("Пожалуйста, введите код из уведомления, отправленного на ваш электронный адрес "+m.join(", "),
null,{inputType:"number",time:18E4}),json=d("registration-validations/auth/challenge/confirm_email_code",{csrf_token:e,track_id:c,code:a,trackId:c},"Запрос на подтверждение кода не принят"),json=d("registration-validations/auth/challenge/commit",{csrf_token:e,track_id:c,challenge:b},"Ошибка подтверждения входа");else if("question"==b)AnyBalance.trace("Требуется ответ на контрольный вопрос"),a=AnyBalance.retrieveCode("Пожалуйста, введите ответ на контрольный вопрос:\n\n"+m,null,{time:18E4}),json=d("registration-validations/auth/challenge/commit",
{csrf_token:e,track_id:c,challenge:b,answer:a},"Ошибка подтверждения входа");else throw AnyBalance.trace(a),new AnyBalance.Error("Затребованный тип проверки не поддерживется: "+b);a=AnyBalance.requestGet("https://passport.yandex.ru/auth/finish/?"+createUrlEncodedParams({track_id:c,retpath:h}),addHeaders({Referer:p}));if(/host/i.test(a)&&/goal/i.test(a))k=getJsonObject(a,/var\s*it\s*=\s*/),k=JSON.stringify(k),h=getParam(k,/"host":"([^"]*)/i,replaceHtmlEntities,decodeURIComponent),k=getParam(k,/"goal":"([^"]*)/i,
replaceHtmlEntities,decodeURIComponent),a=getParam(a,/element2\.value\s?=\s?'([^']*)/i,replaceHtmlEntities,decodeURIComponent),a=AnyBalance.requestPost(h,{goal:k,container:a},addHeaders({"Content-Type":"application/x-www-form-urlencoded",Origin:"https://sso.passport.yandex.ru",Referer:"https://sso.passport.yandex.ru/"}));else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");return a};
