function trace(a){"undefined"!=typeof console&&console&&console.log&&console.log(a);AnyBalance.trace(stringifyCircular(a))}function stringifyCircular(a){var b=[];return JSON.stringify(a,function(d,c){if("object"===typeof c&&null!==c){d=b.indexOf(c);if(-1!==d)return d;c.__reference__id=b.length;b.push(c)}return c})}
function Message(a,b,d){this.__type="com.mobiletransport.messaging.DefaultMessageImpl";this.correlationId=""+Math.floor(-2147483647+4294967294*Math.random());this.id=""+Math.floor(-2147483647+4294967294*Math.random());this.payload=a;this.sendTimestamp=(new Date).getTime();this.theme=b||"Default theme";this.timeToLive=3E4;this.properties=new Properties(d||{})}function Properties(a){this.__type="java.util.Hashtable";for(var b in a)this[b]=a[b]}
function isDate(a){return"[object Date]"==Object.prototype.toString.call(a)}function getType(a,b,d){if(null===a)return"null";if("object"==typeof a&&isDate(a))return"date";if("object"==typeof a&&!isArray(a))return"map";if("object"==typeof a&&isArray(a))return"list";if("string"==typeof a)return"string";if("number"==typeof a)return d&&d.__types&&d.__types[b]||(0===a%1?"long":"double");if("boolean"==typeof a)return"boolean";throw new AnyBalance.Error("Unknown type for "+a+" ("+b+" of "+d+")");}
function fmt2pos(a){return 10>a?"0"+a:""+a}function fmt3pos(a){return 10>a?"00"+a:100>a?"0"+a:""+a}function encodeXML(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function putTypeVal(a,b,d){a.push("<",b,">",serialize(d),"</",b,">")}
function serialize(a){if(null===a)return"";if("object"==typeof a&&isDate(a))return""+a.getUTCFullYear()+fmt2pos(a.getUTCMonth()+1)+fmt2pos(a.getUTCDate())+"T"+fmt2pos(a.getUTCHours())+fmt2pos(a.getUTCMinutes())+fmt2pos(a.getUTCSeconds())+"."+fmt3pos(a.getUTCMilliseconds())+"Z";if("object"!=typeof a||isArray(a)){if("object"==typeof a&&isArray(a)){d=["<type>",encodeXML(a.__type),"</type>","<length>",a.length,"</length>"];for(var b=0;b<a.length;++b)c=getType(a[b],null,a),putTypeVal(d,c,a[b]);return d.join("")}if("string"==
typeof a)return encodeXML(a);if("boolean"==typeof a)return a?"1":"0";if("number"==typeof a)return""+a}else{var d=["<type>",encodeXML(a.__type),"</type>"];for(b in a)if(!/^__types?$/.test(b)){d.push("<string>",encodeXML(b),"</string>");var c=getType(a[b],b,a);putTypeVal(d,c,a[b])}return d.join("")}}
function request(a){var b="<map>"+serialize(a)+"</map>";AnyBalance.trace("Requesting "+getParam(a.payload.__type,null,null,/\.(\w+)$/));var d=CryptoJS.enc.Utf8.parse(b);a=CryptoJS.enc.Utf8.parse("2.37.3");var c=new CryptoJS.lib.WordArray.init([d.sigBytes+a.sigBytes+1,a.sigBytes<<24],5),e=c.sigBytes;c.concat(a).concat(d);d=AnyBalance.requestPost("https://mb.vtb24.ru/mobilebanking/burlap/",CryptoJS.enc.Base64.stringify(c),{"mb-protocol-version":"2.37.3","mb-app-version":"0.1.46",Connection:"Keep-Alive"});
c=CryptoJS.enc.Base64.parse(d);if(400<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Error requesting "+b+": "+CryptoJS.enc.Utf8.stringify(c));b=CryptoJS.enc.Utf8.stringify(c,e+a.sigBytes);AnyBalance.trace(b);b=deserialize(b);if("string"==typeof b.payload)throw new AnyBalance.Error(b.payload);AnyBalance.trace("Returned "+getParam(b.payload.__type,null,null,/\.(\w+)$/));trace(b);if(/ErrorResponse/.test(b.payload.__type))throw new AnyBalance.Error(b.payload.message,null,"invalid-credentials"==
b.payload.type);return b}
function deserialize(a){try{var b=function(f,g,t){if("list"==n)l.push(g(f));else if("map"==n)if(m)l[m]=g(f),m=null;else if(t)m=f;else throw new AnyBalance.Error("deserialize error: unexpected property without name: <"+elem+">"+f);else throw new AnyBalance.Error("deserialize error: unexpected value outside the container: <"+elem+">"+f);},d=new EasySAXParser,c=[],e=[],m=null,n=null,l=null,q=null,k=[],u=0;d.on("error",function(f){AnyBalance.trace(f)});d.on("startNode",function(f,g,t,v,h){q="";switch(f){case "map":l=
{};break;case "list":l=[];break;default:return}k[u++]=l;c.push(l);e.push(m);m=null;n=f});d.on("endNode",function(f,g,t,v){g=q;switch(f){case "type":l.__type=g;break;case "length":if("list"!=n)throw new AnyBalance.Error("deserialize error: unexpected length outside list: <"+f+">"+g);break;case "string":b(g,function(h){return h},!0);break;case "boolean":b(g,function(h){return"true"==h.toLowerCase()||"1"==h});break;case "null":b(g,function(h){return null});break;case "double":b(g,function(h){return parseFloat(h)});
break;case "long":case "int":b(g,function(h){return parseInt(h,10)});break;case "date":b(g,function(h){var p=h.match(/(\d{4})(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)\.(\d\d\d)Z/);if(!p)throw new AnyBalance.Error("deserialize error: unexpected date format: <"+f+">"+h);var r=new Date(0);r.setUTCFullYear(parseInt(p[1],10),parseInt(p[2],10)-1,parseInt(p[3],10));r.setUTCHours(parseInt(p[4],10),parseInt(p[5],10),parseInt(p[6],10),parseInt(p[7],10));if(isNaN(r.getTime()))throw new AnyBalance.Error("Failed to parse date: <"+
f+"> "+h);return r});break;case "map":case "list":g=c.pop();m=e.pop();0<c.length&&(l=c[c.length-1],n=isArray(l)?"list":"map","map"==n?l[m]=g:l.push(g),m=null);break;case "ref":b(g,function(h){h=parseInt(h,10);if(!k[h])throw new AnyBalance.Error("Inexistent reference: "+h+" of "+k.length);return k[h]});break;default:throw new AnyBalance.Error("deserialize error: unexpected tag: <"+f+">"+g);}});d.on("textNode",function(f,g){q=g(f)});d.parse(a);return l}catch(f){throw AnyBalance.trace("Error unserializing xml: "+
a),AnyBalance.trace("Exception: "+f.message+": "+f.stack),f;}}function isSessionValid(){if(!g_commonProperties["CLIENT-TOKEN"])return!1;try{request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioRequest",refreshImmediately:!0,portfolioType:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"ACCOUNTS_AND_CARDS"}},null,g_commonProperties))}catch(a){return!1}return!0}var g_objInfo,g_commonProperties;
function login(){var a=AnyBalance.getPreferences();AnyBalance.trace("Обновление из мобильного приложения");AnyBalance.setOptions({FORCE_CHARSET:"base64",REQUEST_CHARSET:"base64"});checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");var b=AnyBalance.getData("sessionId",a.sessionId||"");g_commonProperties={APP_VERSION:"5.3.8",DEVICE_PLATFORM:"ANDROID","CLIENT-TOKEN":b,DEVICE_OS:"Android OS 5.1.1"};if(isSessionValid())AnyBalance.trace("Пользуемся существующей сессией...");else{AnyBalance.trace("Необходимо авторизоваться...");
b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.StartSessionRequest",sessionContext:{__type:"ru.vtb24.mobilebanking.protocol.security.SessionContextMto",certificateNumber:null,clientIp:"192.168.1.51",outerSessionId:"VTB_TEST_APP",timeoutDuration:null,userAgent:null}})).payload.sessionId;g_commonProperties["CLIENT-TOKEN"]=b;a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.LoginRequest",login:a.login,password:a.password},"LoginRequest theme",g_commonProperties));
if(!a.payload.authorizationLevel||!/Identified/i.test(a.payload.authorizationLevel.id))throw trace(a),new AnyBalance.Error("Неизвестная ошибка. Сайт изменен?");/NONE/i.test(a.payload.authorization.type.id)||AnyBalance.trace("Придется, черт возьми, вводить код: "+a.payload.authorization.type.id);var d=a.payload.userInfo.unc;request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.SelectAuthorizationTypeRequest",authorizationType:a.payload.authorization.type},"SelectAuthorizationTypeRequest theme",
g_commonProperties));a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.GetChallengeRequest"},"GetChallengeRequest theme",g_commonProperties));var c="";/NONE/i.test(a.payload.authorization.type.id)||(c=AnyBalance.retrieveCode(a.payload.authorization.message,null,{inputType:"number",time:3E5}));g_commonProperties.USER_ID=d;g_objInfo=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.ConfirmLoginRequest",inChallengeResponse:c},"ConfirmLoginRequest theme",g_commonProperties));
AnyBalance.setData("sessionId",b);AnyBalance.saveData()}__setLoginSuccessful()}var g_cardsAndAccounts;
function getCardsAndAccounts(){function a(l){for(var q=0;l&&q<l.length;q++){var k=l[q];d[k.id]||(AnyBalance.trace("Found product: "+k.__type+", "+k.displayName+", id: "+k.id),b.payload.products.push(k),d[k.id]=k,a(k.masterAccountCards),a(k.cards),a(k.cardAccount&&[k.cardAccount]),a(k.mainCard&&[k.mainCard]))}}if(g_cardsAndAccounts)return g_cardsAndAccounts;var b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioRequest",refreshImmediately:!0,portfolioType:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",
id:"ACCOUNTS_AND_CARDS"}},null,g_commonProperties));b.payload.products=[];for(var d={},c=0;c<b.payload.portfolios.length;++c)for(var e=b.payload.portfolios[c],m=0;m<e.productGroups.length;++m){var n=e.productGroups[m];a(n.mainProduct&&[n.mainProduct]);a(n.products)}AnyBalance.trace("Найдено "+b.payload.products.length+" продуктов банка");return g_cardsAndAccounts=b}
function processCards(a){if(AnyBalance.isAvailable("cards")){for(var b=getCardsAndAccounts(),d=[],c=0;c<b.payload.products.length;++c){var e=b.payload.products[c];/Card(?!Account)/i.test(e.__type)&&d.push(e)}AnyBalance.trace("Найдено "+d.length+" карт");a.cards=[];for(c=0;c<d.length;c++)e=d[c],b={__id:e.id,__name:e.displayName+" "+e.baseCurrency.currencyCode+" "+e.number.substr(-4),num:e.number},__shouldProcess("cards",b)&&processCard(e,b),a.cards.push(b)}}
function processCard(a,b){AnyBalance.trace("Processing card "+b.__name);getParam(a.displayName,b,"cards.name");getParam(a.balance.allowedSum,b,"cards.balance");getParam(a.balance.amountSum,b,"cards.own");getParam(a.baseCurrency.currencyCode,b,"cards.currency cards.balance cards.gracepay cards.minpay cards.limit cards.own cards.blocked".split(" "));getParam(a.balance.authorizedSum,b,"cards.blocked");getParam(a.embossed,b,"cards.holder");getParam(a.expireDate.getTime(),b,"cards.till");getParam(a.issueDate.getTime(),
b,"cards.date_start");getParam(a.brandName,b,"cards.ps");getParam(a.coBrandName,b,"cards.cobrand");getParam(a.isEmitedForOwner,b,"cards.for_owner");getParam(a.isMain,b,"cards.is_main");getParam(a.status?a.status.id:a.statusDisplayName,b,"cards.status");if(/Credit/.test(a.__type)&&AnyBalance.isAvailable("cards.limit","cards.pct","cards.minpay","cards.gracepay","cards.credit_till","cards.minpay_till","cards.grace_till"))try{var d=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",
identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties)).payload.cardAccount,c=d&&d.loanInfo;d&&null!=d.creditLimit&&getParam(d.creditLimit,b,"cards.limit");c&&(null!=c.interestRate&&getParam(c.interestRate,b,"cards.pct"),null!=c.minAmountForRepayment&&getParam(c.minAmountForRepayment,b,"cards.minpay"),null!=c.graceAmountForRepayment&&getParam(c.graceAmountForRepayment,b,"cards.gracepay"),c.limitEndDate&&getParam(c.limitEndDate.getTime(),
b,"cards.credit_till"),c.repaymentDate&&getParam(c.repaymentDate.getTime(),b,"cards.minpay_till"),c.graceEndDate&&getParam(c.graceEndDate.getTime(),b,"cards.grace_till"))}catch(e){AnyBalance.trace("Не удалось получить данные по кредитной карте "+a.__name+": "+e.message)}AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,b)}
function processAccounts(a){if(AnyBalance.isAvailable("accounts")){for(var b=getCardsAndAccounts(),d=[],c=0;c<b.payload.products.length;++c){var e=b.payload.products[c];/AccountMto/i.test(e.__type)&&d.push(e)}AnyBalance.trace("Найдено "+d.length+" счетов");a.accounts=[];for(c=0;c<d.length;c++)e=d[c],b={__id:e.id,__name:e.displayName+" "+e.amount.currency.currencyCode+" "+e.number.substr(-4),num:e.number},__shouldProcess("accounts",b)&&processAccount(e,b),a.accounts.push(b)}}
function processAccount(a,b){AnyBalance.trace("Processing account "+b.__name);getParam(a.name,b,"accounts.name");getParam(a.amount.sum,b,"accounts.balance");getParam(a.amount.currency.currencyCode,b,["accounts.currency","accounts.balance"]);getParam(a.status.id,b,"accounts.status");a.openDate&&getParam(a.openDate.getTime(),b,"accounts.date_start");a.closeDate&&getParam(a.closeDate.getTime(),b,"accounts.till");if(AnyBalance.isAvailable("accounts.last_op_date")){var d=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",
identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties));d.lastOperationDate&&getParam(d.lastOperationDate.getTime(),b,"accounts.last_op_date")}AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}
function processDeposits(a){if(AnyBalance.isAvailable("deposits")){var b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.MainPageProductsRequest",portfolioTypeMto:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"INVESTMENTS_AND_SAVINGS"}},null,g_commonProperties));AnyBalance.trace("Найдено "+b.payload.products.length+" депозитов");a.deposits=[];if(0==b.payload.products.length)AnyBalance.trace("У вас нет ни одного депозита!");else for(var d=0;d<b.payload.products.length;++d){var c=
b.payload.products[d],e={__id:c.id,__name:c.displayName,num:c.number};__shouldProcess("deposits",e)&&processDeposit(c,e);a.deposits.push(e)}}}
function processDeposit(a,b){AnyBalance.trace("Processing deposit "+b.__name);a.account&&a.account.amount&&(getParam(a.account.amount.sum,b,"deposits.balance"),getParam(a.account.amount.currency.currencyCode,b,["deposits.currency","deposits.balance"]));a.amount&&(getParam(a.amount.sum,b,"deposits.balance"),getParam(a.amount.currency.currencyCode,b,["deposits.currency","deposits.balance"]));a.openDate&&getParam(a.openDate.getTime(),b,"deposits.date_start");(a.endDate||a.closeDate)&&getParam((a.endDate||
a.closeDate).getTime(),b,"deposits.till");a.status&&getParam(a.status.id,b,"deposits.status");AnyBalance.isAvailable("deposits.pct","deposits.own")&&((a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties)).payload.info)?(getParam(a.interestRate,b,"deposits.pct"),getParam(a.depositSum,b,"deposits.own")):AnyBalance.trace("Не найдена доп. информация по депозиту"))}
function processInfo(a){AnyBalance.isAvailable("info")&&(g_objInfo?(a=a.info={},getParam(g_objInfo.payload.userInfo.id,a,"info.id"),getParam(g_objInfo.payload.userInfo.unc,a,"info.unc"),getParam(g_objInfo.payload.userInfo.firstName,a,"info.name"),getParam(g_objInfo.payload.userInfo.lastName,a,"info.name_last"),getParam(g_objInfo.payload.userInfo.patronymic,a,"info.name_patronymic"),getParam(g_objInfo.payload.userInfo.firstNameLatin,a,"info.name_lat"),getParam(g_objInfo.payload.userInfo.lastNameLatin,
a,"info.name_last_lat"),getParam(g_objInfo.payload.userInfo.sex,a,"info.sex"),getParam(g_objInfo.payload.userInfo.phoneWork,a,"info.wphone"),getParam(g_objInfo.payload.userInfo.phoneMobile,a,"info.mphone"),getParam(g_objInfo.payload.userInfo.email,a,"info.email"),getParam(g_objInfo.payload.userInfo.birthday&&g_objInfo.payload.userInfo.birthday.getTime(),a,"info.birthday")):AnyBalance.trace("Info can be obtained with fresh login only!"))}
function processCredits(a){if(AnyBalance.isAvailable("credits")){for(var b=getCardsAndAccounts(),d=[],c=0;c<b.payload.products.length;++c){var e=b.payload.products[c];/LoanContract/i.test(e.__type)&&d.push(e)}AnyBalance.trace("Найдено "+d.length+" кредитов");a.credits=[];for(c=0;c<d.length;c++)e=d[c],b={__id:e.id,__name:e.displayName+" "+e.account.amount.currency.currencyCode+" "+e.number.substr(-4),num:e.number,accnum:e.account.number},__shouldProcess("credits",b)&&processCredit(e,b),a.credits.push(b)}}
function processCredit(a,b){AnyBalance.trace("Processing credit "+b.__name);getParam(a.creditSum.sum,b,"credits.limit");getParam(a.creditSum.currency.currencyCode,b,["credits.currency","credits.balance","credits.limit"]);getParam(a.account.amount.sum,b,"credits.balance");a.account.contract.contractPeriod&&(getParam(a.account.contract.contractPeriod.unit.id,b,"credits.period_unit"),getParam(a.account.contract.contractPeriod.value,b,"credits.period"));a.issueDate&&getParam(a.issueDate.getTime(),b,"credits.date_start");
a.endDate&&getParam(a.endDate.getTime(),b,"credits.till");getParam(a.status.id,b,"credits.status");if(AnyBalance.isAvailable("credits.pct","credits.debt","credits.minpay_debt","credits.minpay_pct","credits.minpay","credits.minpay_till","credits.gracepay","credits.gracepay_till")){var d=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties)).payload.loan;getParam(d.interestRate,
b,"credits.pct");getParam(d.totalLiability,b,"credits.debt");getParam(d.currentLiability,b,"credits.minpay_debt");getParam(d.currentInterest,b,"credits.minpay_pct");getParam(d.repaymentSum,b,"credits.minpay");d.repaymentDate&&getParam(d.repaymentDate.getTime(),b,"credits.minpay_till");null!=d.graceAmountForRepayment&&getParam(d.graceAmountForRepayment,b,"credits.gracepay");null!=d.graceEndDate&&getParam(d.graceEndDate.getTime(),b,"credits.gracepay_till")}if(AnyBalance.isAvailable("credits.schedule"))try{processCreditSchedule(a,
b)}catch(c){AnyBalance.trace("Ошибка получения графика погашения: "+c.message)}if(AnyBalance.isAvailable("credits.transactions"))try{processCreditTransactions(a,b)}catch(c){AnyBalance.trace("Ошибка получения графика погашения: "+c.message)}};
