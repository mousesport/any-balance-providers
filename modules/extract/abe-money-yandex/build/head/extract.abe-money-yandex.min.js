var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36"},g_currency={RUB:"₽",USD:"$",EUR:"€",BYN:"Br",KZT:"₸",GBP:"£",
CNY:"Ұ",CHF:"₣",CZK:"Kč",PLN:"zł",JPY:"¥",undefined:""},g_status={anonymous:"Анонимный",light:"Именной",named:"Именной",identified:"Идентифицированный",undefined:""},g_type={Noncontact:"Бесконтактная",Plastic:"Пластиковая",Virtual:"Виртуальная",undefined:""},g_system={MIR:"МИР",Mir:"МИР",undefined:""},baseurl="https://yoomoney.ru/",g_csrf,g_savedData;
function callApi(b,a){if(!g_csrf)throw new AnyBalance.Error("CSRF token not set!");var c=AnyBalance.requestPost(baseurl+b,JSON.stringify(a),addHeaders({Referer:baseurl,"Content-Type":"application/json;charset=UTF-8","x-csrf-token":g_csrf}));if("yooid/signin/api/process/start/standard"==b&&404==AnyBalance.getLastStatusCode())return callApi("yooid/signin/api/process/start",a);b=JSON.parse(c);if("error"===b.status)throw AnyBalance.trace(c),c=b.message||b.errors&&JSON.stringify(b.errors),new AnyBalance.Error(c,
null,/PASSWORD|ACCOUNT/i.test(c));return b}
function login(){var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");g_savedData||(g_savedData=new SavedData("yoomoney",b.login));g_savedData.restoreCookies();var a=AnyBalance.requestGet(baseurl,g_headers),c=getJsonObject(a,/window.__layoutData__\s*?=/);if(c&&c.user&&c.user.uid)AnyBalance.trace("Already logged in to "+c.user.userName+" ("+b.login+")");else{var d=function(g){if(!g.result)return g.result;if(g.result.nextStepData)return g.result.nextStepData;
if(g.result.nextStep)return g.result};AnyBalance.trace("Logging in anew");a=AnyBalance.requestGet(baseurl+"yooid/signin?origin=Wallet&returnUrl=https%3A%2F%2Fyoomoney.ru%2F",g_headers);g_csrf=getParam(a,/__secretKey__="([^"]*)/);if(!g_csrf)throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти информацию для входа. Сайт изменен?");c=getJsonObject(a,/__data__=/);a=callApi("yooid/signin/api/process/start/standard",{origin:"Wallet",tmxSessionId:"groupib-"+c.staticData.groupIb.sessionId,isAutoStart:!1,
login:b.login});var e=0;do var f=callApiProgress("yooid/signin/api/process/start/standard",{origin:"Wallet",tmxSessionId:"groupib-"+c.staticData.groupIb.sessionId,isAutoStart:!1,login:b.login,processId:a.result.processId,loginType:a.result.loginType});while(!f.result.isLoginSet&&5>++e);if(!f.result.isLoginSet)throw AnyBalance.trace(JSON.stringify(f)),new AnyBalance.Error("Не удалось войти в личный кабинет. Сайт изменен?");for(b=f;b.result&&d(b);)b=processStep(a.result,d(b));a=AnyBalance.requestGet(baseurl)}g_savedData.setCookies();
g_savedData.save();return a}function callApiProgress(b,a){do{c&&AnyBalance.sleep(1E3);var c=callApi(b,a);AnyBalance.trace(b+": "+JSON.stringify(c))}while("progress"===c.status);if((b=c.result&&c.result.status)&&!/^(SUCCESS|ok)$/i.test(b))throw c=c.result.message||c.result.status,new AnyBalance.Error(c,null,/ACCOUNT|PASSWORD/i.test(c));return c}
function processStep(b,a){var c=AnyBalance.getPreferences();AnyBalance.trace("Processing step "+a.nextStep);if("SetPassword"===a.nextStep)c=callApiProgress("yooid/signin/api/password/set",{loginType:b.loginType,processId:b.processId,password:c.password});else if("SetConfirmationCode"===a.nextStep)c=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер "+a.maskedRecipient,null,{inputType:"number",time:17E4}),c=callApiProgress("yooid/signin/api/otp/check",{loginType:b.loginType,
processId:b.processId,contextId:b.processId,answer:c});else if("Require2fa"===a.nextStep)c=callApiProgress("yooid/api/2fa/session/start",{authProcessId:a.authProcessId,type:"Sms"}),c=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер "+c.result.session.phone,null,{inputType:"number",time:17E4}),c=callApiProgress("yooid/api/2fa/session/check",{authProcessId:a.authProcessId,secret:c}),c=callApiProgress("yooid/signin/api/2fa/check",{loginType:b.loginType,processId:b.processId});
else if("Complete"===a.nextStep)c=callApiProgress("yooid/signin/api/process/complete",{loginType:b.loginType,processId:b.processId});else if("SelectAccount"===a.nextStep){AnyBalance.trace("Multiple accounts found: "+JSON.stringify(a.accounts));a=a.accounts.filter(function(d){return"NotRequired"===d.migrationRequirement});if(!a[0])throw new AnyBalance.Error("Не удалось найти готовый для входа аккаунт!");c=callApiProgress("yooid/signin/api/account/select",{loginType:b.loginType,processId:b.processId,
uid:a[0].uid})}else throw new AnyBalance.Error("Неизвестный шаг");return c}
function loginAndGetBalance(b,a){AnyBalance.setDefaultCharset("UTF-8");b=login();var c=getJsonObject(b,/window.__data__\s*?=/),d=getJsonObject(b,/window.__layoutData__\s*?=/);if(c&&c.state){AnyBalance.trace("Загружаем из data...");var e=c.state.account&&c.state.account.accountInfo;e&&e.balances&&(getParam(e.balances.RUB.availableAmount,a,["balance","currency"],null,null,parseBalance),getParam(g_currency[e.balances.RUB.currencyCode]||e.balances.RUB.currencyCode,a,["currency","balance"]));e&&e.bonus?
getParam(e.bonus.availableAmount,a,"bonus",null,null,parseBalance):(b=AnyBalance.requestGet(baseurl+"loyalty",g_headers),e=getJsonObject(b,/window.__data\s*?=/),getParam(e.bonusBalance,a,"bonus",null,null,parseBalance));try{b=AnyBalance.requestGet(baseurl+"cards",g_headers);var f=getJsonObject(b,/window.__data__\s*?=/),g=f.preloadedState&&f.preloadedState.cardList,k=g.ids;if(k&&0<k.length){var h=g.entities[k[0]];getParam(h.panFragment.panLast4,a,"cardNumber",/\d{4}$/,[/(\d{4})/,"**** $1"]);getParam(g_system[h.paymentSystem]||
h.paymentSystem,a,"paymentSystem");getParam(g_type[h.media]||h.media,a,"cardType");var l=getParam(h.expirationDate,null,null,null,null,parseDateISO);if(l){a.cardDate=l;var m=Math.ceil((l-(new Date).getTime())/86400/1E3);0<=m?a.cardDays=m:(AnyBalance.trace("Дата деактивации уже наступила"),a.cardDays=0)}else AnyBalance.trace("Не удалось получить дату действия карты")}}catch(n){AnyBalance.trace("Ошибка получения информации по картам"+n.message)}d&&d.user?(getParam(d.user.accountId,a,"number"),getParam(d.user.accountId,
a,"__tariff"),getParam(d.user.userName,a,"userName"),getParam(g_status[d.user.accountStatus]||d.user.accountStatus,a,"accountStatus")):AnyBalance.trace("Не удалось получить информацию о пользователе");if(AnyBalance.isAvailable("lastOperDate","lastOperSum","lastOperDesc"))if((f=c.state.timeline&&c.state.timeline.history&&c.state.timeline.history.entity)&&0<f.length)for(AnyBalance.trace("Найдено операций: "+JSON.stringify(f.length));0<f.length;){f=f[0];getParam(f.operationDateTime,a,"lastOperDate",
null,null,parseDateISO);getParam(f.amount.value,a,"lastOperSum",null,null,parseBalance);getParam(f.title,a,"lastOperDesc");break}else AnyBalance.trace("Не удалось получить информацию по операциям")}else AnyBalance.trace("Загружаем по-старинке..."),getParam(b,a,"__tariff",/account-number-text(?:[^>]*>)([\d\s]*?)</i,[replaceTagsAndSpaces,/\D/g,""]),getParam(b,a,"number",/account-number-text(?:[^>]*>)([\d\s]*?)</i,[replaceTagsAndSpaces,/\D/g,""]),getParam(b,a,["balance","currency"],/<div[^>]+class="UserBalance[^>]*>[\s\S]*?label="([^"]*)/i,
replaceTagsAndSpaces,parseBalance),getParam(b,a,["currency","balance"],/<div[^>]+class="UserBalance[^>]*>[\s\S]*?label="([^"]*)/i,replaceTagsAndSpaces,parseCurrency),getParam(b,a,"bonus",/<span[^>]+class="qa-bonus-sum"[^>]*>([\s\S]*?балл(?:а|ов)?)<\/span>/i,replaceTagsAndSpaces,parseBalance)}
function processHistory(b){if(AnyBalance.isAvailable("transactions")){var a=0;b.transactions=[];for(var c=1;10>=c;c++){var d=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record="+a+"&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"}));a+=100;d=getJson(d);AnyBalance.trace("Найдено транзакций: "+d.history.length);for(var e=0;e<d.history.length;++e){var f={};getParam((2==d.history[e].type?"-":"")+d.history[e].sum,f,"transactions.sum",
null,replaceTagsAndSpaces,parseBalance);getParam(d.history[e].name,f,"transactions.name",null,replaceTagsAndSpaces);getParam(d.history[e].date,f,"transactions.time",null,replaceTagsAndSpaces,parseDateISO);b.transactions.push(f)}if(!d.hasMore){AnyBalance.trace("Транзакций больше нет...");break}}}}function getCombinedHistory(){return[]}
function combineHistory(b,a){for(var c=0,d=0;c<a.items.length;++c){var e=a.items[c],f=parseDateISOSilent(e.date);if(/за пятый|в категории месяца/i.test(e.name))var g="card";else/за плат[её]ж в интернете/i.test(e.name)?g="internet":!1===e.isIncoming?g="balls":(AnyBalance.trace("Тип начисления баллов неизвестен: "+e.name+"\n"+JSON.stringify(e)),g="unknown");if("balls"!==g){for(;d<b.history.length&&parseDateISOSilent(b.history[d].date)>f;++d);if(d>=b.history.length)break;for(var k=d;k<b.history.length;++k){var h=
b.history[d],l=parseDateISOSilent(h.date);if(3E5<f-l)break;if("card"!==g||h.flags["is-meta-ycard-operation"])if("internet"!==g||h.flags["is-out-shop"]){h.__balls=e;d=k+1;break}}h.__balls||AnyBalance.trace("Не удалось найти транзакцию для баллов "+JSON.stringify(e))}}AnyBalance.trace(c+"/"+a.items.length+" баллов поставлены в соответствие транзакциям")};
