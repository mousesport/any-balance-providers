var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36"},g_baseurl="https://online.rosbank.ru/ibank/",g_Xml_Headers={Accept:"application/xml, text/xml, */*; q=0.01","X-Requested-With":"XMLHttpRequest","Wicket-Ajax":"true","Wicket-Ajax-BaseURL":".",
Referer:g_baseurl+"main"};function findWicketActions(a){a=sumParam(a,null,null,/Wicket.Ajax.ajax\((\{[\s\S]*?\})\);/ig)||[];AnyBalance.trace("Found "+a.length+" Wicket-ajax actions");return a}
function requestWicketAction(a,b,c,d){var e=getParam(a,/c":"([^"]*)/i);a=getParam(a,/u":"\.\/([^"]*)/i);return AnyBalance.requestPost(g_baseurl+a,b,addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"application/xml, text/xml, */*; q=0.01","Wicket-Ajax":"true",Referer:c,"Wicket-Ajax-BaseURL":d,"Wicket-FocusedElementId":e}))}function findWicketActions(a){a=sumParam(a,/Wicket.Ajax.ajax\((\{[\s\S]*?\})\);/ig)||[];AnyBalance.trace("Found "+a.length+" Wicket-ajax actions");return a}
function findExactWicketAction(a,b,c){if(a){for(var d=[],e=0;e<a.length;e++){var f=getJsonEval(a[e].replace(/\^/g,""),"");f.c===b&&d.push(f)}for(e=0;e<d.length;++e)if(f=d[e],!g||c&&f.e==c)var g=(f.u||"").replace(/^.\/main/,"main").replace(/;jsessionid[^?]+/i,"");return g}}
function requestGetWicketActionEx(a,b,c,d){a=requestGetWicketAction(a,b,c,d);do if(/<ajax-response><evaluate>/i.test(a)){b=getParam(a,/"u":"\.\/([^"]*)/);c=getParam(a,/\}\);\},\s*(\d+)/i,null,parseBalance);if(!b||!c)return AnyBalance.trace("Неизвестный отложенный запрос: "+a),a;AnyBalance.trace("Требуется отложить запрос на "+c+" мс. Спим...");AnyBalance.sleep(c);a=AnyBalance.requestGet(g_baseurl+b+"&_="+(new Date).getTime(),addHeaders(g_Xml_Headers))}else return a;while(1)}
function requestGetWicketAction(a,b,c,d){var e=b;if("string"!==typeof e&&(e=getParam(a,b),!e))throw AnyBalance.trace(a),new AnyBalance.Error("Не нашли wicketId "+b.source);a=findWicketActions(a);d=findExactWicketAction(a,e,d);if(!d)throw new AnyBalance.Error("Не удалось найти action: "+e);return c?AnyBalance.requestPost(g_baseurl+d,c,addHeaders({"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},addHeaders(g_Xml_Headers))):AnyBalance.requestGet(g_baseurl+d+"&_="+(new Date).getTime(),
addHeaders(g_Xml_Headers))}function checkForRedirect(a){/<redirect>/i.test(a)&&((a=getParam(a,null,null,/main;[^\]]+/i))||AnyBalance.trace("Запрошен редирект, но ссылка на него не найдена. Сайт изменен?"),a=AnyBalance.requestGet(g_baseurl+a,g_headers));return a}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var b=AnyBalance.requestGet(g_baseurl,g_headers);if(/actionLogout/i.test(b))AnyBalance.trace("Найдена активная сессия. Используем её.");else{var c=getElement(b,/<form[^>]+operation/i);if(!c)throw new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");c=AB.createFormParams(c,function(g,l,h,k){if(!/actionComponent/i.test(h))return/login|fields:field:1:component/i.test(h)?a.login:/password|fields:field:2:component/i.test(h)?
a.password:k});c["actions:list:2:actionComponent"]="1";var d=findWicketActions(b),e=AnyBalance.getLastUrl(),f=getParam(b,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"home?0";b=requestWicketAction(d[4],{"fields:field:1:component":a.login,"":""},e,f);b=requestWicketAction(d[5],{"fields:field:2:component":a.password,"":""},e,f);b=requestWicketAction(d[2],c,e,f);if(/AcceptTerms/i.test(b))throw new AnyBalance.Error("Вы ещё ни разу не входили в интернет-банк или вам требуется сменить пароль. Зайдите в интернет банк через браузер на https://online.rosbank.ru/ibank/, затем попробуйте выполнить провайдер ещё раз");
if(!/redirect|<button[^>]*>\s*Готово\s*<\/button>/i.test(b)){if(c=getParam(b,null,null,/<span[^>]*error[^>]*>([\s\S]*?)<\/span>/i))throw new AnyBalance.Error(c,null,!0);AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся войти в интернет банк. Сайт изменен?");}__setLoginSuccessful()}return b}
function processAccounts(a){if(AnyBalance.isAvailable("accounts")){var b=AnyBalance.requestGet(g_baseurl+"main",g_headers),c=findWicketActions(b),d=AnyBalance.getLastUrl();b=getParam(b,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"main?1";c=getParam(c[c.length-1],null,null,/u":"\.\/([^"]*)/i);b=AnyBalance.requestPost(g_baseurl+c,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":b,Referer:d}));if(d=getElements(b,/<div[^>]*product account/ig).join("\n"))for(a.accounts=[],d=getElements(d,/<div[^>]*mainInfo[^>]*>/ig),
AnyBalance.trace("Нашли "+d.length+" счетов"),b=0;b<d.length;++b){c=d[b];var e=getElement(c,/<[^>]*class="number"/i,replaceTagsAndSpaces),f=getElement(c,/<[^>]*class="name/i,replaceTagsAndSpaces);e={__id:e,__name:f+" "+e.substr(-4),num:e};__shouldProcess("accounts",e)&&processAccount(c,e);a.accounts.push(e)}else AnyBalance.trace(b),AnyBalance.trace("Не удалось получить таблицу счетов")}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a,b,"accounts.balance",/<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.currency",/<span[^>]*class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);if(AnyBalance.isAvailable("accounts.num","accounts.type","accounts.owner")){var c=getParam(a,null,null,/<a[^>]*href="\.\/([^"]*)/i,replaceHtmlEntities);c=AnyBalance.requestGet(g_baseurl+c,
g_headers);var d=findWicketActions(c);a=AnyBalance.getLastUrl();var e=getParam(c,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i);d=getParam(d[d.length-1],null,null,/u":"\.\/([^"]*)/i);a=AnyBalance.requestPost(g_baseurl+d,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":e,Referer:a}));getParam(a,b,"accounts.num",/Номер счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"accounts.type",/Тип счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(a,b,"accounts.owner",/Наименование счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}AnyBalance.isAvailable("accounts.transactions")&&processTransactions(c,b)}
function processTransactions(a,b){AnyBalance.trace("Получаем транзакции для "+b.__name);var c=findWicketActions(a),d=AnyBalance.getLastUrl();a=getParam(a,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i);c=getParam(c[7],null,null,/u":"\.\/([^"]*)/i);a=AnyBalance.requestPost(g_baseurl+c,{ida2_hf_0:"ida2_hf_0","fields:field:1:dateRangeName:select":"CUSTOM","fields:field:2:dateRange:dateFrom:date":getFormattedDate({format:"DD.MM.YYYY",offsetYear:1}),"fields:field:2:dateRange:dateTo:date":getFormattedDate({format:"DD.MM.YYYY"}),
"fields:field:3:filter":"",filterAction:"1"},addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":a,Referer:d}));/загрузка/i.test(a)&&((c=findWicketActions(a))?(c=getParam(c[0],null,null,/u":"\.\/([^"]*)/i),AnyBalance.sleep(5E3),a=AnyBalance.requestGet(g_baseurl+c+"&_="+(new Date).getTime(),addHeaders({"X-Requested-With":"XMLHttpRequest","Wicket-Ajax-BaseURL":d,"Wicket-Ajax":"true"}))):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти ссылку для запроса транзакций")));d=getElements(a,/<div[^>]*class="statementTransaction[^"]*"[^>]*>/ig);
b.transactions=[];for(a=0;a<d.length;a++)c={},getParam(d[a],c,"transactions.sum",/<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(d[a],c,"transactions.descr",/<div[^>]*class="description"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(d[a],c,"transactions.type",/<div[^>]*class="name"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(d[a],c,"transactions.date",/<div[^>]*class="date"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate),
b.transactions.push(c)}
function processCards(a){if(AnyBalance.isAvailable("cards")){var b=AnyBalance.requestGet(g_baseurl+"main",g_headers),c=findWicketActions(b),d=AnyBalance.getLastUrl();b=getParam(b,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"main?1";c=getParam(c[c.length-1],null,null,/u":"\.\/([^"]*)/i);b=AnyBalance.requestPost(g_baseurl+c,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":b,Referer:d}));d=getElements(b,/<div[^>]*cards listView[^>]*>/ig);if(d.length)for(a.cards=[],d=getElements(d.join(),/<div[^>]*accountCard[^>]*>/ig),
AnyBalance.trace("Нашли "+d.length+" карт"),c=0;c<d.length;++c){var e=d[c],f=getElement(e,/<[^>]*class="number"/i,replaceTagsAndSpaces),g=getElement(e,/<[^>]*class="name/i,replaceTagsAndSpaces);f={__id:f,__name:g+" "+f.substr(-4),num:f};__shouldProcess("cards",f)&&processCard(e,f,b);a.cards.push(f)}else AnyBalance.trace(b),AnyBalance.trace("Не удалось получить таблицу карт")}}
function processCard(a,b,c){AnyBalance.trace("Обработка карты "+b.__name);AnyBalance.isAvailable("cards.balance","cards.currency","cards.num","cards.type","cards.blocked","cards.cardholder","cards.date_start")&&(a=getParam(a,/^<[^>]+id="([^"]*)/i,replaceHtmlEntities),c=requestGetWicketAction(c,a),getParam(c,b,"cards.balance",/Доступный остаток(?:[\s\S]*?)<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(c,b,"cards.blocked",/Заблокировано(?:[\s\S]*?)<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseBalance),getParam(c,b,"cards.currency",/Доступный остаток(?:[\s\S]*?)<span[^>]*class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),getParam(c,b,"cards.type",/Тип карты(?:[\s\S]*?)<div[^>]*formcontrol[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(c,b,"cards.cardholder",/Держатель карты(?:[\s\S]*?)<div[^>]*formcontrol[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(c,b,"cards.date_start",/Дата выпуска(?:[\s\S]*?)<span[^>]*formcontrol[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseDate),getParam(c,b,"cards.accnum",/Привязанные счета(?:[\s\S]*?)<div[^>]*class="number"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces));AnyBalance.isAvailable("cards.transactions")&&processTransactions(c,b)}
function processInfo(a){if(AnyBalance.isAvailable("info")){a=a.info={};var b=AnyBalance.requestGet(g_baseurl+"profile",g_headers);getParam(b,a,"info.fio",/Имя пользователя(?:[\s\S]*?)<div[^>]*class="value"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"info.phone",/Отправка SMS на номер телефона(?:[\s\S]*?)<div[^>]*class="description[^"]*"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"info.notify",/Отправка SMS на номер телефона(?:[\s\S]*?)<div[^>]*class="value[^"]*"[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces)}};
