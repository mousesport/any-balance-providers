var g_headers={Accept:"application/json, text/plain, */*","Accept-Charset":"UTF-8","Accept-Language":"ru",Connection:"Keep-Alive","User-Agent":"Dalvik/1.6.0 (Linux; U; Android 4.1.1; Android SDK built for x86 Build/JRO03H)","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-ApiVersion":appVersion},baseurl="https://online.rncb.ru/prest-api/",replaceNumber=[replaceTagsAndSpaces,/\D/g,"",/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7 $1 $2-$3-$4"],g_token,appVersion="1.9.1",device_name="AnyBalance API",
errorsDesc={invalid_grant:"Неверный логин или пароль!"};function setBaseurl(a){baseurl=a}
function apiCall(a,b){a=a.split(":");var d=a[1];b="POST"==a[0]?AnyBalance.requestPost(baseurl+d,b,g_token?addHeaders({Authorization:"Bearer "+g_token}):g_headers):AnyBalance.requestGet(baseurl+d,addHeaders({Authorization:"Bearer "+g_token}));a=AnyBalance.getLastStatusCode();if(400<=a){AnyBalance.trace(b);if(401==a)throw new AnyBalance.Error("Ошибка авторизации. Проверьте логин и пароль");if(b&&(b=getJson(b),a=b.error,"invalid_grant"==a?(setToken(),a="Неверный логин или пароль"):a=b.error_description||
(b.error?errorsDesc[b.error]:b.error),a))throw new AnyBalance.Error(a,null,/Неверный логин или пароль/i.test(a));throw new AnyBalance.Error("Ошибка при подключении к сайту провайдера. Попробуйте обновить данные позже");}return b=getJson(b)}function checkSetToken(a){if(!a)throw new AnyBalance.Error("Не пришел токен в ответе банка. Сайт изменен?");setToken(a)}function setToken(a){AnyBalance.setData("access_token",g_token=a);AnyBalance.saveData()}
function setCredentials(a,b){if(!a||!b)throw new AnyBalance.Error("Не удалось сохранить данные авторизации. web_mobile_login: "+a+" web_mobile_password: "+b);AnyBalance.setData("credentials",{web_mobile_login:a,web_mobile_password:b});AnyBalance.saveData()}function getCredentials(a){return a.__debugData?(AnyBalance.trace("Используем данные из преференсов..."),a.__debugData.credentials):AnyBalance.getData("credentials")}
function getToken(a){return a.__debugData?(AnyBalance.trace("Используем данные из преференсов..."),g_token=a.__debugData.access_token):g_token=AnyBalance.getData("access_token")}
function login(a){AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");if(getToken(a)){AnyBalance.trace("Устройство уже привязано. Используем текущую сессию");a=getCredentials(a);if(!a)throw setToken(),new AnyBalance.Error("Устройство привязано неправильно. Сбрасываем сессию");b=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:a.web_mobile_password,appVersion:appVersion,uuid:"ee5ba11cfba9170c",
web_mobile_login:a.web_mobile_login,jailBreak:"false",grant_type:"password"});checkSetToken(b.access_token)}else{var b=apiCall("POST:authentication/oauth2",[["grant_type","password"],["password",a.password],["username",a.login]]);checkSetToken(b.access_token);"otp"==b.scope&&(AnyBalance.trace("Необходимо ввести код для привязки устройства"),a=AnyBalance.retrieveCode("Пожалуйста, введите код из SMS"),AnyBalance.trace("Код получен: "+a),b=apiCall("POST:authentication/otp",[["grant_type","password"],
["password",a],["device_name",device_name]]),a=b.username,b=b.password,setCredentials(a,b),b=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:b,appVersion:appVersion,uuid:"ee5ba11cfba9170c",web_mobile_login:a,jailBreak:"false",grant_type:"password"}),checkSetToken(b.access_token),AnyBalance.trace("Устройство успешно привязано"),__setLoginSuccessful())}return b}
function processAccounts(a){if(AnyBalance.isAvailable("accounts")){var b=apiCall("GET:protected/accounts");AnyBalance.trace("Найдено счетов: "+b.length);a.accounts=[];for(var d=0;d<b.length;++d){var c=b[d],e={__id:c.id,__name:c.currencyCode+" "+c.number};__shouldProcess("accounts",e)&&processAccount(c,e);a.accounts.push(e)}}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a.number,b,"accounts.contractNumber");getParam(g_type[a.type]||a.type,b,"accounts.accountType");getParam(a.depositPercent+"",b,"accounts.percent",null,replaceTagsAndSpaces,parseBalance);getParam(a.balance+"",b,"accounts.balance",null,replaceTagsAndSpaces,parseBalance);getParam(g_currency[a.currencyCode]||a.currencyCode,b,["accounts.currency","accounts.balance"]);getParam(a.depositName,b,"accounts.formattedName",/.*/,
[/"/g,""]);getParam(g_state[a.state]||a.state,b,"accounts.statusDescription");getParam(a.depositOpenDate,b,"accounts.openDate");getParam(a.depositEndDate,b,"accounts.endDate");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}
function processCards(a){if(AnyBalance.isAvailable("cards")){var b=apiCall("GET:protected/cards");AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var d=0;d<b.length;++d){var c=b[d],e={__id:c.id,__name:c.currencyCode+" "+c.number};__shouldProcess("cards",e)&&processCard(c,e);a.cards.push(e)}}}
function processCard(a,b){AnyBalance.trace("Обработка карты "+b.__name);getParam(a.balance+"",b,"cards.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.availableAmount+"",b,"cards.availableAmount",null,replaceTagsAndSpaces,parseBalance);getParam(a.lockedAmount+"",b,"cards.lockedAmount",null,replaceTagsAndSpaces,parseBalance);getParam(g_currency[a.currencyCode]||a.currencyCode,b,["cards.currency","cards.balance","cards.availableAmount","cards.lockedAmount","cards.creditLimit"]);getParam(a.cardAccount&&
a.cardAccount.number,b,"cards.contractNumber");getParam(a.cardAccount&&a.cardAccount.creditLimit,b,"cards.creditLimit",null,replaceTagsAndSpaces,parseBalance);getParam(a.openDate,b,"cards.openDate");getParam(a.expireDate,b,"cards.endDate");getParam(a.number,b,"cards.number",/\d{16}$/,[/(\d{4})(\d{2})(\d{2})(\d{4})(\d{4})/,"$1 $2** **** $5"]);getParam(a.cardName,b,"cards.formattedName");getParam(a.statusDescription,b,"cards.statusDescription");getParam(a.type,b,"cards.type");getParam(1*a.expireDate,
b,"cards.expireDate");"undefined"!=typeof processCardTransactions&&processCardTransactions(a,b)}function processDeposits(a){if(AnyBalance.isAvailable("deposits")){var b=apiCall("GET:protected/accounts");AnyBalance.trace("Найдено счетов: "+b.length);a.deposits=[];for(var d=0;d<b.length;++d){var c=b[d];if(/DEPOSIT/i.test(c.type)){var e={__id:c.id,__name:c.currencyCode+" "+c.number};__shouldProcess("deposits",e)&&processDeposit(c,e);a.deposits.push(e)}}}}
function processDeposit(a,b){AnyBalance.trace("Обработка депозита "+b.__name);getParam(a.number,b,"deposits.contractNumber");getParam(g_type[a.type]||a.type,b,"deposits.accountType");getParam(a.depositPercent+"",b,"deposits.percent",null,replaceTagsAndSpaces,parseBalance);getParam(a.balance+"",b,"deposits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(g_currency[a.currencyCode]||a.currencyCode,b,["deposits.currency","deposits.balance"]);getParam(a.depositName,b,"deposits.formattedName",
/.*/,[/"/g,""]);getParam(g_state[a.state]||a.state,b,"deposits.statusDescription");getParam(a.depositOpenDate,b,"deposits.openDate");getParam(a.depositEndDate,b,"deposits.endDate");AnyBalance.isAvailable("deposits.transactions")&&processDepositTransactions(a,b)}function processCredits(a){throw new AnyBalance.Error("Кредиты пока не поддерживаются. Пожалуйста, обратитесь к автору провайдера для добавления продукта");}
function processCredit(a,b){AnyBalance.trace("Обработка кредита "+b.__name);getParam(a.number,b,"credits.contractNumber");getParam(g_type[a.type]||a.type,b,"credits.accountType");getParam(a.creditPercent+"",b,"credits.percent",null,replaceTagsAndSpaces,parseBalance);getParam(a.balance+"",b,"credits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(g_currency[a.currencyCode]||a.currencyCode,b,["credits.currency","credits.balance"]);getParam(a.creditName,b,"credits.formattedName",/.*/,[/"/g,
""]);getParam(g_state[a.state]||a.state,b,"credits.statusDescription");getParam(a.creditOpenDate,b,"credits.openDate");getParam(a.creditEndDate,b,"credits.endDate");AnyBalance.isAvailable("credits.transactions")&&processCreditTransactions(a,b)}function processInfo(a){if(AnyBalance.isAvailable("info")){a.info={};var b=apiCall("GET:protected/client");getParam(b.phone,a.info,"info.phone",null,replaceNumber);getParam(b.fullName,a.info,"info.fio",null,null,capitalFirstLetters)}};
