var g_baseurl="https://online.raiffeisen.ru/",g_currency={RUB:"₽",RUR:"₽",USD:"$",EUR:"€",GBP:"£",JPY:"Ұ",CHF:"₣",CNY:"¥",undefined:""},g_headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36",Accept:"application/json, text/plain, */*",Connection:"keep-alive","Accept-Language":"ru",Referer:g_baseurl,Origin:g_baseurl.replace(/\/$/,"")},g_token,g_loginInfo;
function callApi(b,a,d){if(!g_token&&"oauth/token"!=b)throw new AnyBalance.Error("Внутренняя ошибка, сайт изменен?");var c=g_token?/oauth\/entry\/confirm/i.test(b)?addHeaders({Authorization:""}):addHeaders({Authorization:"Bearer "+g_token}):addHeaders({Authorization:"Basic b2F1dGhVc2VyOm9hdXRoUGFzc3dvcmQhQA=="});a&&(c["Content-Type"]="application/json; charset=UTF-8");AnyBalance.trace("Запрос: "+b);a=AnyBalance.requestPost(g_baseurl+b,a&&JSON.stringify(a),c,{HTTP_METHOD:d||"GET"});if(401==AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),
new AnyBalance.Error("Отказ в доступе. Неправильный логин или пароль?",null,!0);if(460==AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Отказ в доступе. Неверный код подтверждения?",null,!0);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка вызова API "+b+": "+AnyBalance.getLastStatusCode());b=getJson(a);AnyBalance.trace("Ответ: "+JSON.stringify(b));return b}
function login(b){b=AnyBalance.getPreferences();AB.checkEmpty(b.login,"Введите логин!");AB.checkEmpty(b.password,"Введите пароль!");if(!g_token){var a=AnyBalance.requestGet(g_baseurl+"import/web/config/online.raiffeisen.ru.json?date="+(new Date).getTime(),g_headers);a=getJson(a);if(a.reCaptcha3&&!0===a.reCaptcha3.enabled)var d=solveRecaptcha("Пожалуйста, докажите, что вы не робот",AnyBalance.getLastUrl(),JSON.stringify({SITEKEY:a.reCaptcha3.siteKey,TYPE:"V3",ACTION:"login",USERAGENT:g_headers["User-Agent"]}));
a=callApi("oauth/token",{username:b.login,password:b.password,uiVersion:"RC3.0-GUI-5.57.1",reCaptchaResponse:d,node:" ",grant_type:"password"},"POST");g_token=a.access_token;AnyBalance.trace("g_token: "+g_token);if(!g_token)throw new AnyBalance.Error("Не удалось получить токен авторизации. Сайт изменен?");if(!0!==a.is_push_otp_disable){AnyBalance.trace("Сайт затребовал проверку входа с помощью кода из SMS");a=callApi("oauth/entry/confirm/sms",{},"POST");d=a.requestId;AnyBalance.trace("requestId: "+
d);if(!d)throw new AnyBalance.Error("Не удалось получить идентификатор запроса. Сайт изменен?");b=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер телефона, указанный при заключении Договора банковского обслуживания",null,{inputType:"number",time:a.await});a=callApi("oauth/entry/confirm/"+d+"/sms",{code:b},"PUT")}g_loginInfo=a}}
function processInfo(b){if(AnyBalance.isAvailable("info")){b.info={};var a=g_loginInfo;if(!a)throw new AnyBalance.Error("Не удаётся получить общую информацию");getParam(a.resource_owner.fullName,b.info,"info.fio");getParam(a.resource_owner.birthDate,b.info,"info.birthday",null,null,parseDateISO);getParam(a.resource_owner.address,b.info,"info.address");getParam(a.resource_owner.mobilePhone.replace(/.*(\d{3})(\d{3})(\d{2})(\d{2})$/i,"+7 $1 $2-$3-$4"),b.info,"info.mphone");getParam(a.resource_owner.email,
b.info,"info.email");getParam(a.resource_owner.passportNumber,b.info,"info.passport");getParam(a.resource_owner.passportIssuer,b.info,"info.passportissuer");getParam(a.resource_owner.passportDate,b.info,"info.passportissuedate",null,null,parseDateISO);getParam(a.username,b.info,"info.login")}}
function processCards(b){if(isAvailable("cards")){var a=callApi("rest/card?alien=false");AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(var d=0;d<a.length;++d){var c=a[d],e=c.id;c=c.paymentSystem.name+" "+c.pan.substr(-4);e={__id:e,__name:c};__shouldProcess("cards",e)&&processCard(a[d],e);b.cards.push(e)}}}
function processCard(b,a){function d(f){return isAvailable(f)&&!isset(a[f])?!0:!1}getParam(b.balance,a,"cards.balance");getParam(b.currencyId,a,"cards.currencyFull cards.currency cards.balance cards.minpay cards.limit cards.totalCreditDebtAmount cards.blocked".split(" "));getParam(g_currency[b.currencyId]||b.currencyId,a,"cards.currency cards.currencyFull cards.balance cards.minpay cards.limit cards.totalCreditDebtAmount cards.blocked".split(" "));getParam(b.hold,a,"cards.blocked");getParam(b.type.id,
a,"cards.type_code");getParam(b.type.name,a,"cards.type");getParam(b.pan,a,"cards.num");getParam(b.account.cba,a,"cards.accnum");getParam(b.expire,a,"cards.till",null,replaceTagsAndSpaces,parseDateISO);getParam(b.status.name,a,"cards.status");getParam(b.product,a,"cards.name");getParam(b.cardholder,a,"cards.holder");getParam(1==b.main.id,a,"cards.isMain");getParam(b.open,a,"cards.dateStart",null,null,parseDateISO);getParam(b.paymentSystem.name,a,"cards.shortType");getParam(b.rate,a,"cards.rate");
if("2"==b.type.id&&(isAvailable(["cards.totalCreditDebtAmount","cards.clearBalance","cards.own"])||d("cards.limit")||d("cards.minpay"))){var c=callApi("rest/account/"+b.accountId+"/statement/current?alien=false"),e=getParam(c.creditLimit,null,null,null,replaceTagsAndSpaces,parseBalance),g=getParam(c.ownFunds,null,null,null,replaceTagsAndSpaces,parseBalance);getParam(e,a,"cards.limit");getParam(g,a,"cards.own");getParam(c.minAmount,a,"cards.minpay",null,replaceTagsAndSpaces,parseBalance);getParam(b.balance-
e,a,"cards.clearBalance");getParam(c.totalDebt,a,"cards.totalCreditDebtAmount",null,replaceTagsAndSpaces,parseBalance);getParam(c.unpaidGracePeriodDue,a,"cards.gracepay",null,replaceTagsAndSpaces,parseBalance);getParam(c.longGraceDueDate,a,"cards.gracepay_till",null,replaceTagsAndSpaces,parseDateISO)}"undefined"!=typeof processCardTransactions&&processCardTransactions(b,a)}
function processAccounts(b){if(isAvailable("accounts")){var a=callApi("rest/account?alien=false");AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var d=0;d<a.length;++d){var c=a[d];c={__id:c.id,__name:c.type.name+" "+c.currencyId+" "+c.cba};__shouldProcess("accounts",c)&&processAccount(a[d],c);b.accounts.push(c)}}}
function processAccount(b,a){getParam(b.balance,a,"accounts.balance");getParam(b.hold,a,"accounts.blocked");getParam(b.currencyId,a,["accounts.currencyFull","accounts.currency","accounts.minpay","accounts.limit","accounts.balance"]);getParam(g_currency[b.currencyId]||b.currencyId,a,["accounts.currency","accounts.currencyFull","accounts.minpay","accounts.limit","accounts.balance"]);getParam(b.cba,a,"accounts.num");getParam(b.open,a,"accounts.date_start",null,null,parseDateISO);getParam(b.type.name,
a,"accounts.type");"undefined"!=typeof processAccountTransactions&&processAccountTransactions(b,a)}function processDeposits(b){if(isAvailable("deposits")){var a=callApi("rest/deposit?alien=false");AnyBalance.trace("Найдено депозитов: "+a.length);b.deposits=[];for(var d=0;d<a.length;++d){var c=a[d];c={__id:c.id,__name:c.product.name.name+" "+c.deals[0].currencyId+" "+c.number};__shouldProcess("deposits",c)&&processDeposit(a[d],c);b.deposits.push(c)}}}
function processDeposit(b,a){getParam(b.deals[0].cba,a,"deposits.num");getParam(b.deals[0].currentAmount,a,"deposits.balance");getParam(b.deals[0].startAmount,a,"deposits.balance_start");getParam(b.deals[0].currencyId,a,["deposits.currencyFull","deposits.currency","deposits.balance","deposits.currentAmount"]);getParam(g_currency[b.deals[0].currencyId]||b.deals[0].currencyId,a,["deposits.currency","deposits.currencyFull","deposits.balance","deposits.currentAmount"]);getParam(b.deals[0].rate,a,"deposits.pct");
getParam(b.deals[0].duration,a,"deposits.period");getParam(b.deals[0].paidInterest,a,"deposits.pcts");getParam(b.deals[0].close,a,"deposits.till",null,null,parseDateISO);getParam(b.deals[0].open,a,"deposits.date_start",null,null,parseDateISO);getParam(b.product.name.name,a,"deposits.name")}
function processLoans(b){if(isAvailable("credits")){var a=callApi("rest/loan");AnyBalance.trace("Найдено кредитов: "+a.length);b.credits=[];for(var d=0;d<a.length;++d){var c=a[d].id;c={__id:c,__name:"Кредит "+c};__shouldProcess("credits",c)&&processLoan(a[d],c);b.credits.push(c)}}}
function processLoan(b,a){getParam(b.rate,a,"credits.pct","",replaceTagsAndSpaces,parseBalance);getParam(b.start,a,"credits.limit","",replaceTagsAndSpaces,parseBalance);getParam(b.leftDebt,a,"credits.balance","",replaceTagsAndSpaces,parseBalance);getParam(b.pay,a,"credits.minpay","",replaceTagsAndSpaces,parseBalance);getParam(b.paidDebt,a,["credits.paid","credits.paidLoanIntrest"],"",replaceTagsAndSpaces,parseBalance);getParam(b.paid-b.paidDebt,a,["credits.paidLoanIntrest","credits.paid"],"",replaceTagsAndSpaces,
parseBalance);getParam(b.currencyId,a,"credits.currencyFull credits.currency credits.limit credits.balance credits.paid credits.paidLoanIntrest credits.minpay".split(" "));getParam(g_currency[b.currencyId]||b.currencyId,a,"credits.currency credits.currencyFull credits.limit credits.balance credits.paid credits.paidLoanIntrest credits.minpay".split(" "));getParam(b.next,a,"credits.minpay_till","",replaceTagsAndSpaces,parseDateISO);getParam(b.close,a,"credits.till","",replaceTagsAndSpaces,parseDateISO);
getParam(b.open,a,"credits.date_start","",replaceTagsAndSpaces,parseDateISO)};
